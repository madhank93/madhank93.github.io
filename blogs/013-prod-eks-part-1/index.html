<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href=" /deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Madhan | Production ready EKS cluster setup — Part I

  </title>

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=&lt;your_gtag&gt;"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "&lt;your_gtag&gt;");
  </script>
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href=" ">Madhan</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;blogs">
            Blogs
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;til">
            TIL
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;projects">
            Projects
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;archive">
            Archive
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;uses">
            Uses
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;tags">
            Tags
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Production ready EKS cluster setup — Part I
          </h1>
          <p class="subtitle">Using AWS CloudFormation infrastructure as a tool to provision the EKS cluster</p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Madhan published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span
    ><time datetime="2023-08-11T01:25:33+05:30"
      >August 11, 2023</time
    ></span
  >
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>3 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>594 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
              
<p>
  Tags: 
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/eks/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>eks</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/aws/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>aws</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/cloud-formation/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>cloud-formation</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/iac/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>iac</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/k8s/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>k8s</span>
    </span>
  </a>
  
</p>

              
            </div>
          </div>
          <div class="content mt-2">
            <p><img src="https://cdn-images-1.medium.com/max/3840/1*ohvTASQBpHSRzpUQdffJEg.png" alt="AWS EKS — CloudFormation" /></p>
<p>In this article, we are going to see how to create a Production ready EKS cluster by following the steps using the CloudFormation template and AWS dashboard.</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*Mdp6f6Lyckfgf5LDA3tb6A.png" alt="Overall steps" /></p>
<h3 id="1-setting-up-networking-components"><a href="https://docs.aws.amazon.com/eks/latest/userguide/creating-a-vpc.html">1. Setting up networking components</a></h3>
<p>When it comes to networking setup Amazon EKS service has specific <a href="https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html">requirements and considerations</a> for the VPC and subnets in the cluster being deployed. And AWS also <a href="https://docs.aws.amazon.com/eks/latest/userguide/creating-a-vpc.html">maintains</a> a CloudFormation <a href="https://s3.us-west-2.amazonaws.com/amazon-eks/cloudformation/2020-10-29/amazon-eks-vpc-private-subnets.yaml">template</a> that can help us create VPC and subnets.</p>
<p>Head on to CloudFormation section, choose to Create stack option, and add the following AWS S3 URL template it has the option of creating subnets in both public and private.</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>https://s3.us-west-2.amazonaws.com/amazon-eks/cloudformation/2020-10-29/amazon-eks-vpc-private-subnets.yaml
</span></code></pre>
<p>After uploading the template you’ll have the option to customize the CIDR blocks. And I’m naming this stack has the <code>eks-vpc-stack</code>.</p>
<p><img src="https://cdn-images-1.medium.com/max/2810/1*6-0xIfJAUpO1hjIqZV-4yg.png" alt="VPC parameter config" /></p>
<h3 id="2-creating-an-iam-role"><a href="https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html">2. Creating an IAM role</a></h3>
<p>AWS-managed Kubernetes EKS service needs to access other AWS services on your behalf to manage the resources. For that, we need to create an IAM role with access to <a href="https://docs.aws.amazon.com/aws-managed-policy/latest/reference/AmazonEKSClusterPolicy.html">AmazonEKSClusterPolicy</a> and I’m naming it as <code>eks-cluster-role</code></p>
<p><img src="https://cdn-images-1.medium.com/max/2662/1*ZBLIYJaZF6udwYbKks7AUw.png" alt="IAM role" /></p>
<h3 id="3-creating-an-eks-cluster">3. Creating an EKS cluster</h3>
<p>Upon creating the EKS cluster make sure to select the previously created VPC &amp; IAM role as follows and complete the setup.</p>
<p><img src="https://cdn-images-1.medium.com/max/2032/1*Zkhn-zWFqXVsuDp_PxNU8Q.png" alt="" /></p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*J3UXDgM4bFz8MV91OeNxtg.png" alt="EKS setup" /></p>
<p>Once the setup is completed, update the kube config details using AWS CLI. You can now access the namespace but not the Kubernetes nodes since we haven’t configured the worker nodes yet.</p>
<p><img src="https://cdn-images-1.medium.com/max/3208/1*5TltVWPbtBmgPkNpfXIMyA.png" alt="AWS kubeconfig setup" /></p>
<h3 id="4-creating-self-managed-worker-nodes"><a href="https://docs.aws.amazon.com/eks/latest/userguide/launch-workers.html">4. Creating self-managed worker nodes</a></h3>
<p>Go to CloudFormation stack and add the following template to it.</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>https://s3.us-west-2.amazonaws.com/amazon-eks/cloudformation/2022-12-23/amazon-eks-nodegroup.yaml
</span></code></pre>
<p>In the parameter section, provide the <code>ClusterName</code> matching the EKS cluster name we’ve created and selecting the appropriate VPC, Subnets, Security Group, and SSH key pair.</p>
<h3 id="5-joining-worker-nodes-to-the-control-plane">5. Joining Worker nodes to the Control plane</h3>
<p>To attach the worker nodes to the control plane, modify the following yml file key <code>rolearn</code> with the arn value of <code>NodeInstanceRole</code> (created as part of the Worker node CloudFormation template). And apply the k8s file to attach the worker nodes to the control plane.</p>
<pre style="background-color:#282a36;color:#f8f8f2;"><code><span>apiVersion: v1
</span><span>kind: ConfigMap
</span><span>metadata:
</span><span>  name: aws-auth
</span><span>  namespace: kube-system
</span><span>data:
</span><span>  mapRoles: |
</span><span>    - rolearn: arn:aws:iam::942487838076:role/eks-worker-node-NodeInstanceRole-1B9EVIY7CEYD8
</span><span>      username: system:node:{{EC2PrivateDNSName}}
</span><span>      groups:
</span><span>        - system:bootstrappers
</span><span>        - system:nodes
</span></code></pre>
<p>Once the above k8s file is applied successfully; we can able to get all the nodes by running the below command.</p>
<p><img src="https://cdn-images-1.medium.com/max/3206/1*Y1PJS3RKlp5X213FW6rkIA.png" alt="EKS — nodes" /></p>
<div align="center">* * * *</div>
<center>
<p>Originally published on <a href="https://medium.com/@madhankumaravelu93/production-ready-eks-cluster-setup-part-i-49a4eba171cc">Medium</a></p>
</center>
<p><strong>References:</strong></p>
<p>[1] <a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html">https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html</a></p>

          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-1-setting-up-networking-components" class="toc is-size-7 is-active"
                href=" /blogs/013-prod-eks-part-1/#1-setting-up-networking-components">
                1. Setting up networking components
              </a>
              
            </li>
            
            <li>
              <a id="link-2-creating-an-iam-role" class="toc is-size-7 "
                href=" /blogs/013-prod-eks-part-1/#2-creating-an-iam-role">
                2. Creating an IAM role
              </a>
              
            </li>
            
            <li>
              <a id="link-3-creating-an-eks-cluster" class="toc is-size-7 "
                href=" /blogs/013-prod-eks-part-1/#3-creating-an-eks-cluster">
                3. Creating an EKS cluster
              </a>
              
            </li>
            
            <li>
              <a id="link-4-creating-self-managed-worker-nodes" class="toc is-size-7 "
                href=" /blogs/013-prod-eks-part-1/#4-creating-self-managed-worker-nodes">
                4. Creating self-managed worker nodes
              </a>
              
            </li>
            
            <li>
              <a id="link-5-joining-worker-nodes-to-the-control-plane" class="toc is-size-7 "
                href=" /blogs/013-prod-eks-part-1/#5-joining-worker-nodes-to-the-control-plane">
                5. Joining Worker nodes to the Control plane
              </a>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href=" &#x2F;blogs&#x2F;012-lld-parking-lot-part-2&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Low level system design — Parking Lot Design Part — II
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href=" &#x2F;blogs&#x2F;014-aws-iam&#x2F;">
              AWS services — Identity Access Management (IAM)<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  
  
  <script src=" /elasticlunr.min.js"></script>
  <script src=" /search_index.en.js"></script><script src=" /js/site.js"></script>

  

<script type="text/javascript">
  const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>





  
  
</body>

</html>
