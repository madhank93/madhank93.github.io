<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href=" /deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Madhan | Making my homelab server AI ready with Nvidia GPU — Part II

  </title>

  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=&lt;your_gtag&gt;"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());
    gtag("config", "&lt;your_gtag&gt;");
  </script>
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href=" ">Madhan</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;blogs">
            Blogs
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;til">
            TIL
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;projects">
            Projects
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;archive">
            Archive
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;uses">
            Uses
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href=" &#x2F;tags">
            Tags
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Making my homelab server AI ready with Nvidia GPU — Part II
          </h1>
          <p class="subtitle">A End-to-End guide on GPU Passthrough</p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Madhan published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span
    ><time datetime="2025-07-06T00:00:00+00:00"
      >July 06, 2025</time
    ></span
  >
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>3 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>518 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
              
<p>
  Tags: 
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/gpu/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>gpu</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/homelab/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>homelab</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/proxmox/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>proxmox</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/ai/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>ai</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/nvidia/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>nvidia</span>
    </span>
  </a>
  
  <a
    class="has-text-info-dark has-text-weight-semibold"
    href=" /tags/pulumi/"
  >
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>pulumi</span>
    </span>
  </a>
  
</p>

              
            </div>
          </div>
          <div class="content mt-2">
            <p><img src="https://cdn-images-1.medium.com/max/3840/0*zim-0XEcp9-91Ilt.png" alt="Icons — flaticon" /></p>
<p>Since my previous post on <a href="https://medium.com/@madhankumaravelu93/gpu-pass-through-in-proxmox-using-pulumi-c1972e64a4bb">GPU passthrough in Proxmox using Pulumi</a>, I’ve made a significant improvements in my homelab automation stack. This blog post covers the migration to the latest Ubuntu image, kernel upgrades, enhanced cloud-init automation, and the usage of workflow using justfile.</p>
<h2 id="upgrading-to-the-latest-kernel">Upgrading to the latest Kernel</h2>
<p>The most notable change is the adoption of the Ubuntu 24.04 cloud image as the default VM template. This ensures improved hardware compatibility, and optimal support for AI workloads. The config.yml file now points directly to the official Ubuntu 24.04 cloud image.</p>
<pre data-lang="yaml" style="background-color:#282a36;color:#f8f8f2;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#ff79c6;">proxmox</span><span>:
</span><span>    </span><span style="color:#ff79c6;">username</span><span>: </span><span style="color:#f1fa8c;">root@pam
</span><span>    </span><span style="color:#ff79c6;">endpoint</span><span>: </span><span style="color:#f1fa8c;">https://192.168.1.235:8006/
</span><span>    </span><span style="color:#ff79c6;">nodename</span><span>: </span><span style="color:#f1fa8c;">proxmox
</span><span>    </span><span style="color:#ff79c6;">image_url</span><span>: </span><span style="color:#f1fa8c;">https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img
</span></code></pre>
<p>This change makes sures that all new VMs will boot with the latest LTS release and kernel, which is essential for modern NVIDIA drivers.</p>
<h2 id="enhanced-cloud-init">Enhanced cloud-init</h2>
<p>The cloud-init configuration has been modified to include,</p>
<ul>
<li>
<p><strong>NVIDIA driver auto install</strong>: The <code>runcmd</code> section now leverages <code>ubuntu-drivers autoinstall</code> for automatic NVIDIA driver installation, ensuring GPU-enabled VMs are ready for AI workloads.</p>
</li>
<li>
<p><strong>Kernel and header installation</strong>: The script ensures the latest kernel and headers are present.</p>
</li>
</ul>
<h2 id="centralized-configuration">Centralized configuration</h2>
<p>To streamline the deployment process, all environment specific settings are now centralized in config.yml (for cluster and node definitions) and .env (for sensitive data like passwords) added to gitignore. Pulumi code dynamically loads these configurations at runtime.</p>
<ul>
<li>
<p><code>config.yml</code>: Stores Proxmox credentials, endpoint, node name, and image URL.</p>
</li>
<li>
<p><code>.env</code>: Holds secrets such as the Proxmox password.</p>
</li>
</ul>
<h2 id="vm-creation-with-gpu-passthrough">VM creation with GPU passthrough</h2>
<p>When provisioning a VM that requires GPU access, the Pulumi Go code dynamically adjusts the VM specification. By setting HasGPU: true and specifying PCIe IDs, the correct passthrough configuration is automatically applied during provisioning.</p>
<pre data-lang="go" style="background-color:#282a36;color:#f8f8f2;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#ff79c6;">if </span><span style="color:#ffffff;">config</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">HasGPU </span><span>{
</span><span>    </span><span style="color:#ffffff;">args</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">Bios </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">String</span><span>(</span><span style="color:#f1fa8c;">&quot;ovmf&quot;</span><span>)
</span><span>    </span><span style="color:#ffffff;">args</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">Machine </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">String</span><span>(</span><span style="color:#f1fa8c;">&quot;q35&quot;</span><span>)
</span><span>    </span><span style="font-style:italic;color:#8be9fd;">var </span><span>hostpcis </span><span style="color:#ffffff;">vm</span><span style="color:#ff79c6;">.</span><span style="font-style:italic;color:#8be9fd;">VirtualMachineHostpciArray
</span><span>    </span><span style="color:#ff79c6;">for </span><span>i, pcieID </span><span style="color:#ff79c6;">:= range </span><span style="color:#ffffff;">config</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">PcieIDs </span><span>{
</span><span>        </span><span style="color:#ffffff;">hostpcis </span><span style="color:#ff79c6;">= </span><span style="color:#8be9fd;">append</span><span>(</span><span style="color:#ffffff;">hostpcis</span><span>, </span><span style="color:#ffffff;">vm</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">VirtualMachineHostpciArgs</span><span>{
</span><span>            </span><span style="color:#ffffff;">Device</span><span>: </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">String</span><span>(</span><span style="color:#f1fa8c;">&quot;hostpci0&quot;</span><span>),
</span><span>            </span><span style="color:#ffffff;">Pcie</span><span>:   </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Bool</span><span>(</span><span style="color:#bd93f9;">true</span><span>),
</span><span>            </span><span style="color:#ffffff;">Id</span><span>:     </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">String</span><span>(</span><span style="color:#ffffff;">pcieID</span><span>),
</span><span>            </span><span style="color:#ffffff;">Xvga</span><span>:   </span><span style="color:#ffffff;">pulumi</span><span style="color:#ff79c6;">.</span><span style="color:#50fa7b;">Bool</span><span>(</span><span style="color:#ffffff;">i </span><span style="color:#ff79c6;">== </span><span style="color:#bd93f9;">0</span><span>),
</span><span>        })
</span><span>    }
</span><span>    </span><span style="color:#ffffff;">args</span><span style="color:#ff79c6;">.</span><span style="color:#ffffff;">Hostpcis </span><span style="color:#ff79c6;">= </span><span style="color:#ffffff;">hostpcis
</span><span>}
</span></code></pre>
<h2 id="automation-with-justfile">Automation with justfile</h2>
<p>Using a <a href="https://github.com/casey/just">Justfile</a> allows you to define repeatable commands,</p>
<pre data-lang="yml" style="background-color:#282a36;color:#f8f8f2;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#ff79c6;">deploy</span><span>:
</span><span>    </span><span style="color:#f1fa8c;">pulumi up
</span><span>
</span><span style="color:#ff79c6;">preview</span><span>:
</span><span>    </span><span style="color:#f1fa8c;">pulumi preview
</span><span>
</span><span style="color:#ff79c6;">destroy</span><span>:
</span><span>    </span><span style="color:#f1fa8c;">pulumi destroy
</span><span>
</span><span style="color:#ff79c6;">refresh</span><span>:
</span><span>    </span><span style="color:#f1fa8c;">pulumi refresh
</span></code></pre>
<ul>
<li>
<p><code>just up</code> – Deploy or update the cluster</p>
</li>
<li>
<p><code>just destroy</code> – Tear down all the resources</p>
</li>
</ul>
<h2 id="output">Output</h2>
<p>The output of <a href="https://docs.nvidia.com/deploy/nvidia-smi/index.html">nvidia-smi</a> confirms NVIDIA GPUs are correctly detected and operational within the VM. This utility provides real-time details on GPU status, driver versions, memory usage, and running processes.</p>
<p><img src="https://cdn-images-1.medium.com/max/3254/1*-Of-6ku12kz9YYIm9S8XMg.png" alt="" /></p>
<div align="center">* * * *</div>
<center>
<p>Originally published on <a href="https://medium.com/@madhankumaravelu93/making-my-homelab-server-ai-ready-with-nvidia-gpu-part-ii-a6ef95b7282b">Medium</a></p>
<p>🌟 🌟 🌟 <strong>The source code for this blog post can be found here</strong> 🌟🌟🌟</p>
<p><a href="https://github.com/madhank93/homelab">GitHub - madhank93/homelab</a></p>
</center>
<p><strong>Reference</strong>:</p>
<p>[1] <a href="https://pve.proxmox.com/wiki/PCI_Passthrough#How_to_know_if_a_graphics_card_is_UEFI_.28OVMF.29_compatible">https://pve.proxmox.com/wiki/PCI_Passthrough</a></p>
<p>[2] <a href="https://docs.nvidia.com/deploy/nvidia-smi/index.html">https://docs.nvidia.com/deploy/nvidia-smi/index.html</a></p>
<p>[3] <a href="https://just.systems/man/en/">https://just.systems/man/en/</a></p>

          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-upgrading-to-the-latest-kernel" class="toc is-size-7 is-active"
                href=" /blogs/033-nvidia-gpu-part-2/#upgrading-to-the-latest-kernel">
                Upgrading to the latest Kernel
              </a>
              
            </li>
            
            <li>
              <a id="link-enhanced-cloud-init" class="toc is-size-7 "
                href=" /blogs/033-nvidia-gpu-part-2/#enhanced-cloud-init">
                Enhanced cloud-init
              </a>
              
            </li>
            
            <li>
              <a id="link-centralized-configuration" class="toc is-size-7 "
                href=" /blogs/033-nvidia-gpu-part-2/#centralized-configuration">
                Centralized configuration
              </a>
              
            </li>
            
            <li>
              <a id="link-vm-creation-with-gpu-passthrough" class="toc is-size-7 "
                href=" /blogs/033-nvidia-gpu-part-2/#vm-creation-with-gpu-passthrough">
                VM creation with GPU passthrough
              </a>
              
            </li>
            
            <li>
              <a id="link-automation-with-justfile" class="toc is-size-7 "
                href=" /blogs/033-nvidia-gpu-part-2/#automation-with-justfile">
                Automation with justfile
              </a>
              
            </li>
            
            <li>
              <a id="link-output" class="toc is-size-7 "
                href=" /blogs/033-nvidia-gpu-part-2/#output">
                Output
              </a>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href=" &#x2F;blogs&#x2F;032-nvidia-gpu-part-1&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Making my homelab server AI ready with Nvidia GPU — Part I
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href=" &#x2F;blogs&#x2F;034-nvidia-gpu-k8s&#x2F;">
              Adding Nvidia GPU boost to Proxmox k8s using Pulumi and Kubespray<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  
  
  <script src=" /elasticlunr.min.js"></script>
  <script src=" /search_index.en.js"></script><script src=" /js/site.js"></script>

  

<script type="text/javascript">
  const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>





  
  
</body>

</html>
